<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="utf-8">
      <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="../css/materialize.min.css"  media="screen,projection"/>
<!--       <link type="text/css" rel="stylesheet" href="../css/pages.css"  media="screen,projection"/>
 -->      
      <title>D3 Test</title>

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <link rel="shortcut icon" href="../images/bike-favicon.ico" type="image/x-icon">

      <!-- link to d3 -->
      <script type='text/javascript' src="../d3/d3.js"></script>
      <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
      <script src="https://d3js.org/d3-collection.v1.min.js"></script>
      <style>
        .d3-tip {
            line-height: 1;
            padding: 12px;
            background: rgba(43,43,43, 0.8);
            color: #fff;
            border-radius: 2px;
        }
      </style>
    </head>

    <body class="case-study">
        <nav class="my-nav">
            <span class="small-nav" id="hamburger">
            <img src=".././images/hamburger-menue-icon.png" class=".small-nav" height="30" width="30" alt="">
            </span>
            <span class="big-nav" id="nav-span">
            
            <span class="nav-body">
                <a href="./../index.html">Home</a>
                <a href="mailto:jordanhiattcodes@gmail.com">Contact Me</a>
                <a href="../images/jordan-resume DME.pdf" download>Resume</a>

            </span>
            <span class="nav-side">
                <a href="https://github.com/jhiatt" target="_blank">
                <img src="./../images/GitHub-logo-square.png" alt="Github Profile" height="30" width="30" />
                </a>
                <a href="https://www.linkedin.com/in/jordanhiatt/" target="_blank">
                <img src="./../images/ln-black.png" alt="LinkedIn Profile" height="30" width="30" />
                </a>
                <a href="https://medium.com/@jhiatt" target="_blank">
                <img src="./../images/medium-monogram.png" alt="Medium Blog" height="30" width="30" />
                </a>
        <!--             <a target="_blank" href="">Design Make Experiment</a>  -->          
            </span>
            </span>
        </nav>


        <!-- NOTES:
            - helpful article: https://observablehq.com/@d3/zoom-to-bounding-box 
            - https://observablehq.com/@duynguyen1678/choropleth-with-tooltip
            - start local server: "python -m http.server 8888 &." launches http://localhost:8888/
            - 
        -->

        <script type='text/javascript'>
            
            // SVG SETUP
            // Establish the svg parameters
            const width = 1000;
            const height = 600;
            const margin = 10;
            
            // Projection
            var projection = d3.geoAlbersUsa()
                               .translate([width/2, height/2]) //translate to move everything to the middle
            //    .scale([500]) //defalut scale for projection is 1000
            
            // Path
            var path = d3.geoPath()
                         .projection(projection);
            
            // Color
            var color = d3.scaleQuantize()
                          .range(['#fff7fb','#ece7f2','#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']) //thanks 'https://colorbrewer2.org/#type=sequential&scheme=PuBu&n=9'
            
            // set up tooltips
            // thanks to Louise Whitaker http://bl.ocks.org/lwhitaker3/e8090246a20d9515789b
            // var tip = d3.tip()
            //     .attr('class', 'd3-tip')
            //     .offset([-5, 0])
            //     .html(function(d) {
            //         console.log(d)
            //         if (d) {
            //             console.log(d);
            //             return d.properties.name + ": " + d.total_value;
            //         } else {
            //             console.log("no dataRow", d);
            //         //     return d.properties.name + ": No data.";
            //         }
            //     })

            // Create SVG element
            var svg = d3.select('body')
                        .append('svg')
                        // .create("svg")
                        .attr("viewBox", [-margin, 0, width + margin, height + margin]);
            

            // set up legend
            // svg
            //     .append("g")
            //     .attr("transform", "translate(610,20)")
            //     .append(() => legend({ color, title: 'data.title', width: 260 }));    


            // add tool tips
            // svg.call(tip,);

            d3.csv('https://raw.githubusercontent.com/jhiatt/county_data/main/cleaned_data/unemployment.csv').then(function(csv){
                // load csv data
                console.log(csv)
                
                //get min and max for setting color
                color.domain([
                    d3.min(csv, function(d) { return d.Unemployment_rate}),
                    d3.max(csv, function(d) { return d.Unemployment_rate})
                ]);

                // selected period
                let period_selection = 'Sep-19'

                // save it to a map for easy look up
                // this will create a map with fips as keys and an object containing rate information as the variables
                var data = new Map()
                for (var i=0; i<csv.length; i++) {
                    // save each row to the map
                    // the rate information is in the form of an object with peiod as keys.  If we add additional information we can substitute an array or object for the rate variable (keep the period as the key)
                    let fips = csv[i].fips;
                    if(data.has(fips)) { // if fips is already in the map
                        obj = data.get(fips)
                        obj[csv[i].Period]=csv[i].Unemployment_rate
                    } else { // first fips
                        data.set(fips,{[csv[i].Period]: csv[i].Unemployment_rate})
                    }
                }
                console.log(data)


                //LOAD COUNTY DATA
                var counties
                d3.json('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json').then(function(json) {
                    counties = json
                    console.log(counties)

                    svg
                        .append("g")
                        .attr("id", "map")
                        .selectAll('path')
                        .data(counties.features)
                        .enter()
                        .append('path')
                        .attr("class", "county")
                        .attr('d', path)
                        .attr('stroke', 'black') //enable/disable this with an option?
                        .attr('stroke-width','.2px')
                        .style('fill', function(d) {
                            //data value
                            var value = data.get(d.id); 

                            if(value) {
                                return color(value[period_selection]); // pulls the color for that value established by d3 with d3.scaleQuantize().domain
                            } else {
                                return '#ccc'; // return gray if no value
                            }
                        })

                        const tooltip = svg.append("g");
                        format = d => `${d}%`;

                        svg
                        .selectAll(".county")
                        .on("touchmove mousemove", function(event, d) {
                            m = data.get(d.id)
                            tooltip.call(
                            callout,
                            `${format(m[period_selection])}
                        ${d.properties.NAME}` //, ${states.get(d.id.slice(0, 2)).name}
                            );
                            tooltip.attr("transform", `translate(${d3.pointer(event, this)})`);
                            d3.select(this)
                            .attr("stroke", "red")
                            .raise();
                        })
                        .on("touchend mouseleave", function() {
                            tooltip.call(callout, null);
                            d3.select(this)
                            .attr("stroke", null)
                            .lower();
                        });
                })

                //LOAD STATE DATA
                var states = new Map()
                d3.json('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json').then(function(st_json) {
                    console.log(st_json)
                    // for (var j=0; j<csv.length; j++) {
                        // states.set(csv[j].fips,)
                    // }
                })
 

            })

            callout = (g, value) => {
                if (!value) return g.style("display", "none");

                g
                    .style("display", null)
                    .style("pointer-events", "none")
                    .style("font", "10px sans-serif");

                const path = g.selectAll("path")
                    .data([null])
                    .join("path")
                    .attr("fill", "white")
                    .attr("stroke", "black");

                const text = g.selectAll("text")
                    .data([null])
                    .join("text")
                    .call(text => text
                    .selectAll("tspan")
                    .data((value + "").split(/\n/))
                    .join("tspan")
                        .attr("x", 0)
                        .attr("y", (d, i) => `${i * 1.1}em`)
                        .style("font-weight", (_, i) => i ? null : "bold")
                        .text(d => d));

                const {x, y, width: w, height: h} = text.node().getBBox();

                text.attr("transform", `translate(${-w / 2},${15 - y})`);
                path.attr("d", `M${-w / 2 - 10},5H-5l5,-5l5,5H${w / 2 + 10}v${h + 20}h-${w + 20}z`);
            }
            </script>

            
            <label for="begDate">Starting Period: </label>

            <select name="begDate" id="begDate">
              <!-- <option value="volvo">Volvo</option>
              <option value="saab">Saab</option>
              <option value="mercedes">Mercedes</option>
              <option value="audi">Audi</option> -->
            </select>
            <div>
                <button>Unemployment Rate</button>
                <button>Presidential Election</button>
                <button>Population</button>
            </div>

            <h1>County Data Project</h1>





<!--Import jQuery before materialize.js-->
<script type="text/javascript" src="./../js/nav/navbar-mini.js"></script>
</body>
</html>