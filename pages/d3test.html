<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="utf-8">
      <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="../css/materialize.min.css"  media="screen,projection"/>
<!--       <link type="text/css" rel="stylesheet" href="../css/pages.css"  media="screen,projection"/>
 -->      
      <title>D3 Test</title>

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <link rel="shortcut icon" href="../images/bike-favicon.ico" type="image/x-icon">

      <!-- link to d3 -->
      <script type='text/javascript' src="../d3/d3.js"></script>
      <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
      <script src="https://d3js.org/d3-collection.v1.min.js"></script>
      <style>
        .d3-tip {
            line-height: 1;
            padding: 12px;
            background: rgba(43,43,43, 0.8);
            color: #fff;
            border-radius: 2px;
        }
      </style>
    </head>

    <body class="case-study">
        <nav class="my-nav">
            <span class="small-nav" id="hamburger">
            <img src=".././images/hamburger-menue-icon.png" class=".small-nav" height="30" width="30" alt="">
            </span>
            <span class="big-nav" id="nav-span">
            
            <span class="nav-body">
                <a href="./../index.html">Home</a>
                <a href="mailto:jordanhiattcodes@gmail.com">Contact Me</a>
                <a href="../images/jordan-resume DME.pdf" download>Resume</a>

            </span>
            <span class="nav-side">
                <a href="https://github.com/jhiatt" target="_blank">
                <img src="./../images/GitHub-logo-square.png" alt="Github Profile" height="30" width="30" />
                </a>
                <a href="https://www.linkedin.com/in/jordanhiatt/" target="_blank">
                <img src="./../images/ln-black.png" alt="LinkedIn Profile" height="30" width="30" />
                </a>
                <a href="https://medium.com/@jhiatt" target="_blank">
                <img src="./../images/medium-monogram.png" alt="Medium Blog" height="30" width="30" />
                </a>
        <!--             <a target="_blank" href="">Design Make Experiment</a>  -->          
            </span>
            </span>
        </nav>


        <!-- NOTES:
            - helpful article: https://observablehq.com/@d3/zoom-to-bounding-box 
            - https://observablehq.com/@duynguyen1678/choropleth-with-tooltip
            - start local server: "python -m http.server 8888 &." launches http://localhost:8888/
            - 
        -->

        <script type='text/javascript'>
            
            // SVG SETUP
            // Establish the svg parameters
            const width = 1000;
            const height = 600;
            const margin = 10;
            
            // Projection
            var projection = d3.geoAlbersUsa()
                               .translate([width/2, height/2]) //translate to move everything to the middle
            //    .scale([500]) //defalut scale for projection is 1000
            
            // Path
            var path = d3.geoPath()
                         .projection(projection);
            
            // Color
            var color = d3.scaleQuantize()
                          .range(['#fff7fb','#ece7f2','#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858']) //thanks 'https://colorbrewer2.org/#type=sequential&scheme=PuBu&n=9'
            
            // set up tooltips
            // thanks to Louise Whitaker http://bl.ocks.org/lwhitaker3/e8090246a20d9515789b
            // var tip = d3.tip()
            //     .attr('class', 'd3-tip')
            //     .offset([-5, 0])
            //     .html(function(d) {
            //         console.log(d)
            //         if (d) {
            //             console.log(d);
            //             return d.properties.name + ": " + d.total_value;
            //         } else {
            //             console.log("no dataRow", d);
            //         //     return d.properties.name + ": No data.";
            //         }
            //     })

            // Create SVG element
            var svg = d3.select('body')
                        .append('svg')
                        // .create("svg")
                        .attr("viewBox", [-margin, 0, width + margin, height + margin]);
            

            // set up legend
            // svg
            //     .append("g")
            //     .attr("transform", "translate(610,20)")
            //     .append(() => legend({ color, title: 'data.title', width: 260 }));    


            // add tool tips
            // svg.call(tip,);

 

            
            // LOAD DATA
            d3.json('https://raw.githubusercontent.com/jhiatt/county_data/main/cleaned_data/unempGeo.json').then(function(json) {
                console.log(json)
                json_map = d3.map(json)

                // SET DATE RANGE
                //look up sample date range (picked a random early one, not the first one, all data has been checked to ensure they have the same date range of data with NA's to fill the gaps)

                // use date_range for looking up specific dates. Use position in array rather than values, dates should all be in the same order.
                var date_range = [];
                var json_data = json.features[5].properties.counties[0].value.data;

                for (var i=0; i<json_data.length; i++) {
                    date_range.push(json_data[i][1])
                }

                // these should be index numbers
                var beg_date = 10
                var end_date = date_range.length

                // console.log(date_range.slice(beg_date,end_date))


                // SIMPLIFY PATH DATA

                // create a data object to store coordinates and unemployment info
                var path_data = []

                // note: we don't use the state data yet, we could flatten the incoming json data to just reside at the county level and add state info there.
                for (var j=0; j<json.features.length; j++){
                    var counties = json.features[j].properties.counties;
                    for (var k=0; k<counties.length; k++) {

                        // sum value and add it to county data
                        // get the appropriate range of values for the correct periods
                        var range = counties[k].value.data.slice(beg_date,end_date);

                        // pull out only the values
                        var range_values = []
                        for (var l=0; l<range.length; l++){
                            range_values.push(range[l][0]);
                        }

                        // sum to get single number
                        var sum_range = range_values.reduce((a,b) => parseFloat(a)+parseFloat(b),0);

                        // save to geojson
                        counties[k].total_value = sum_range;
                        path_data.push(counties[k])
                    }
                }

                console.log(path_data)
                path_map = d3.map(path_data)
                // link data to color scale
                color.domain([
                    d3.min(path_data, function(d) { return d.total_value}),
                    d3.max(path_data, function(d) { return d.total_value})
                ]);

                
                // not working, state lines not showing above county lines	
                // svg.select("#map")
                //         .data(json.features)	
                //         .append('path')	
                //         .attr('d', path)	
                //         // .attr('stroke-width', '10px')	
                //         .attr("stroke", "white")	
                //         .attr('fill','none')



                // Bind data to a single path with the GeoJason feature
                svg
                    .append("g")
                    .attr("id", "map")
                    .selectAll('path')
                    .data(path_data)
                    .enter()
                    .append('path')
                    .attr("class", "county")
                    .attr('d', path)
                    // .on('mouseover', tip.show)
                    // .on('mouseout', tip.hide)
                    .attr('stroke', 'black') //enable/disable this with an option?
                    .attr('stroke-width','.2px')
                    .style('fill', function(d) {
                        //data value
                        var value = d.total_value;

                        if(value) {
                            return color(value); // pulls the color for that value established by d3 with d3.scaleQuantize().domain
                        } else {
                            return '#ccc'; // return gray if no value
                        }
                    })
                    // .append('title')
                    // .text((d) => 'County: ${d.properties.name}, ${d.total_value}')
                
                    const tooltip = svg.append("g");

                    svg
                        .selectAll(".county")
                        .on("touchmove mousemove", function(event, d) {
                        tooltip.call(
                    //         callout,
                    //         `${format(path_map.get(d.id))}
                    // ${d.properties.name}, ${json_map.get(d.id.slice(0, 2)).name}`
                    //     );
                    //     tooltip.attr("transform", `translate(${d3.pointer(event, this)})`);
                        d3.select(this)
                            .attr("stroke", "red")
                            .raise();
                        })
                        .on("touchend mouseleave", function() {
                        tooltip.call(callout, null);
                        d3.select(this)
                            .attr("stroke", null)
                            .lower();
                        });             
                
            });

            // import {callout} from @d3/line-chart-with-tooltip
            format = d => `${d}%`
            callout = (g, value) => {
  if (!value) return g.style("display", "none");

  g
      .style("display", null)
      .style("pointer-events", "none")
      .style("font", "10px sans-serif");

  const path = g.selectAll("path")
    .data([null])
    .join("path")
      .attr("fill", "white")
      .attr("stroke", "black");

  const text = g.selectAll("text")
    .data([null])
    .join("text")
    .call(text => text
      .selectAll("tspan")
      .data((value + "").split(/\n/))
      .join("tspan")
        .attr("x", 0)
        .attr("y", (d, i) => `${i * 1.1}em`)
        .style("font-weight", (_, i) => i ? null : "bold")
        .text(d => d));

  const {x, y, width: w, height: h} = text.node().getBBox();

  text.attr("transform", `translate(${-w / 2},${15 - y})`);
  path.attr("d", `M${-w / 2 - 10},5H-5l5,-5l5,5H${w / 2 + 10}v${h + 20}h-${w + 20}z`);
}
            </script>
            <label for="begDate">Starting Period: </label>

            <select name="begDate" id="begDate">
              <!-- <option value="volvo">Volvo</option>
              <option value="saab">Saab</option>
              <option value="mercedes">Mercedes</option>
              <option value="audi">Audi</option> -->
            </select>
            <div>
                <button>Unemployment Rate</button>
                <button>Presidential Election</button>
                <button>Population</button>
            </div>

            <h1>County Data Project</h1>





<!--Import jQuery before materialize.js-->
<script type="text/javascript" src="./../js/nav/navbar-mini.js"></script>
</body>
</html>